<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="ml4u-list.html">

<dom-module id="ml4u-view-session">

<style is="custom-style">
:host {
}

section.itemViewHeader {
  color: white;
  background-color: var(--app-primary-color);
  padding: 5px;
  font-weight: bold;
  font-family: 'effra', sans-serif;
  font-weight: 500;
  letter-spacing: -0.02em;
  font-size: 20px;
  vertical-align: middle;
}

#sessionInfo {
  padding: 14px 30px 14px 30px;
  background: #FAFAFA;
  box-shadow: 0 1px 3px 0 rgba(0,0,0,0.35);
}
.timeandloc {
  margin-top: 3px;
  font-size: 1.2em;
  font-family: 'effra', sans-serif;
  color: #989898;
}
span.loc {
  float: right;
}
.sessionTitle {
  font-size: 1.7em;
  font-weight: 500;
  font-family: 'effra', sans-serif;
  color: #4A4A4A;
  margin: 8px 0px 9px 0px;
}
.bottomSessionInfo {
  font-size: 16px;
}
#papersDiv {
  margin-top: 1px;
  background-color: white;
}

</style>
<template>
  <section class="itemViewHeader">
    <paper-icon-button dialog-confirm icon="icons:close"></paper-icon-button>
    <span>Session</span>
  </section>
  <section class="container">
    <div id="sessionInfo">
      <div class="timeandloc"><span>{{session.session_time_start}} - {{session.session_time_end}}</span><span class="loc">{{session.location}}</span></div>
      <div class="sessionTitle">{{session.session}}</div>
      <!--<div class="bottomSessionInfo"><span style="color: #989898;">Chair: </span><span style="color: #000000;">{{session.session_chair}}</span></div>-->
    </div>
    <div id="papersDiv">
      <template is="dom-repeat" items="{{papers_top}}" initialCount="10">
        <div>
          <ml4u-list-item list-item="{{item}}" selected-item="{{selectedPaper}}"
            encompassing-session-type="[[session.type_code]]"
            is-paper is-bookmarked=[[item.isBookmarked]]></ml4u-list-item>
        </div>
      </template>
      <template is="dom-repeat" items="{{papers}}" initialCount="10">
        <template is="dom-if" if="[[!item.isHidden]]"
          <div>
            <ml4u-list-item list-item="{{item}}" selected-item="{{selectedPaper}}"
              encompassing-session-type="[[session.type_code]]"
              is-paper is-bookmarked=[[item.isBookmarked]]></ml4u-list-item>
          </div>
        </template>
      </template>
<!--      <ml4u-list items="[[papers]]"
          selected-item={{selectedPaper}} id-prefix="sched" is-paper-list></ml4u-list>-->
    </div>
  </section>
</template>

<script>
  Polymer({
    is: 'ml4u-view-session',
    properties: {
      sessionId: String,
      session: {
        type: Object,
        computed: '_computeSession(sessionId)'
      },
      papers: {
        type: Object,
        computed: '_computePapersList(sessionId)'
      },
      papers_top: {
        type: Array,
        value: []
      },
      selectedPaper: {
        type: String,
        notify: true
      },
      needsReload: {
        type: Number,
        notify: true,
        value: 0
      },
      profileData: {
        type: Object,
        notify: true
      },
      loggedIn: {
        type: Number
      }
    },
    observers: [
      /*'updateBookmarks(papers, profileData.bookmarks)'*/
      '_onPapersChanged(papers)',
      '_onBookmarksChanged(profileData.bookmarks)',
    ],
    _onPapersChanged: function() {
      //TODO: call only if session,type_code=poster
      this.updatePaperOrder();
    },
    _onBookmarksChanged: function() {
      console.log("_onBookmarksChanged called");
      //TODO: call only if session,type_code=poster
      this.updatePaperOrder();
    },
    updatePaperOrder: function() {
      papers = this.papers;
      if(papers == undefined) {
        return;
      }
      hasBookmarks = this.loggedIn && this.profileData.bookmarks != undefined;
      bookmarks = hasBookmarks ? this.profileData.bookmarks : {};

      papers_top = new Array();
      /*first, iterate all papers and set hidden to false*/
      for(var paperIndex=0; paperIndex<papers.length; ++paperIndex) {
        selectedAsTop = false;
        currentPaper = papers[paperIndex];
        if(this.loggedIn) {
          //first check for bookmarks
          isBookmarked = this.profileData.bookmarks[items[paperIndex].id] != undefined ? 1 : 0;
          if(isBookmarked) {
            selectedAsTop = true;
            currentPaper.isBookmarked = isBookmarked;
          }
        }
        if(selectedAsTop) {
          papers_top.push(currentPaper);
          this.set('papers.' + paperIndex + ".isHidden", 1);
        }
        else {
          this.set('papers.' + paperIndex + ".isHidden", 0);
          this.set('papers.' + paperIndex + ".isBookmarked", 0);
        }
        //papers[paperIndex].hidden = false;
        //papers[paperIndex].isBookmarked = 0;
      }
      this.papers_top = papers_top;

      /*add bookmarks to papers1_top
      if(this.loggedIn && this.profileData.bookmarks != undefined) {
        numberOfPapers = paper.length;
        bookmarked_array = Object.keys(this.profileData.bookmarks);
        numberOfBookmarks = bookmarked_array.length;
        if(numberOfPapers > numberOfBookmarks) {
          for(var i=0; i<numberOfBookmarks; ++i) {

          }
        }

        for(var i=0; i<items.length; ++i) {

          isBookmarked = this.profileData.bookmarks[items[i].id] != undefined ? 1 : 0;

          this.set('papers.' + i + ".isBookmarked", isBookmarked);
        }
      }*/

    },
    updateBookmarks: function(items, profileData) {
      console.log("updateBookmarks called?! from view-session");
      if(items == undefined) {
        return;
      }
      //performing the if out the for loop, so I don't have to evaluate it N times
      if(this.loggedIn && this.profileData.bookmarks != undefined) {
        for(var i=0; i<items.length; ++i) {
          isBookmarked = this.profileData.bookmarks[items[i].id] != undefined ? 1 : 0;
          this.set('papers.' + i + ".isBookmarked", isBookmarked);
        }
      }
      else {
        for(var i=0; i<items.length; ++i) {
          this.set('papers.' + i + ".isBookmarked", 0);
        }
      }
    },
    _computeSession: function(sessionId) {
      console.log("hello from _computeSession, where sessionId is:");
      console.log(sessionId);
      if(sessionId == undefined || sessionId=="") {
        return {};
      }
      if(window.ml4u == undefined || window.ml4u.sharedElements == undefined
        || window.ml4u.sharedElements.scheduleDataProvider == undefined) {
        //postpone the reloading for later.
        this.needsReload = 1;
        return {};
      }
      session = window.ml4u.sharedElements.scheduleDataProvider.getSession(sessionId);
      console.log("returning session:");
      console.log(session);
      return session;
    },
    _computePapersList: function(sessionId) {
      if(sessionId == undefined || sessionId=="") {
        return [];
      }
      if(window.ml4u == undefined || window.ml4u.sharedElements == undefined
        || window.ml4u.sharedElements.scheduleDataProvider == undefined) {
        //postpone the reloading for later.
        this.needsReload = 1;
        return [];
      }
      papers = window.ml4u.sharedElements.scheduleDataProvider.getSessionItems(sessionId);
      return papers;
    }

  });
  </script>
</dom-module>
