<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html">

<dom-module id="ml4u-db-provider">
  <template>

    <app-pouchdb-document
      db-name="schedule"
      doc-id="schedulenew"
      data="{{scheduleData}}">
    </app-pouchdb-document>

    <app-pouchdb-document
      db-name="schedule"
      doc-id="trending"
      data="{{trending}}">
    </app-pouchdb-document>

    <app-pouchdb-document
      db-name="schedule"
      doc-id="topics"
      data="{{topics}}">
    </app-pouchdb-document>

  </template>
  <script>
    Polymer({
      is: 'ml4u-db-provider',
      properties: {
        scheduleData: {
          type: Object,
          notify: true,
          value: null
        },
        trending: {
          type: Object,
          notify: true
        },
        topics: {
          type: Object,
          notify: true
        },
        isReady: {
          type: Number,
          notify: true
        }
      },
      /*
      observers: [
        'scheduleDataChanged(scheduleData.*)'
      ],
      scheduleDataChanged(e) {
        if(this.scheduleData == undefined || this.scheduleData._rev == undefined)
          return;

        console.log("scheduleDataChanged called");
        console.log(this.scheduleData);
        //this.fire('iron-signal', {name: 'schedule', data: null});
      },*/
      getSessionsSchedule: function(day, track) {
        if(this.scheduleData == undefined || this.scheduleData.sessions == undefined)
          return [];
        return this.scheduleData.sessions[day][track];
      },
      getPostersSchedule: function(day) {
        if(this.scheduleData == undefined || this.scheduleData.sessions == undefined)
          return [];
        var posterSessionsForTheDay = new Array();
        var posterSessionIds = this.scheduleData.posterSessionsByDay[day].posterSessionsIds;
        //Note: the number of poster sessons per day is 1 or 2
        //therefore, the following loop won't execute many times.
        for(var i=0; i<posterSessionIds.length; i++) {
          var currentPosterSessionId = posterSessionIds[i];
          var currentPosterSessionIdMapping = this.scheduleData.sessionIdToIndexMapping[currentPosterSessionId];
          var currentPosterSession = this.scheduleData.sessions[currentPosterSessionIdMapping.indexInSessionsArray][currentPosterSessionIdMapping.indexInRelevantDaySessionArray];
          posterSessionsForTheDay.push(currentPosterSession);
        }
        return posterSessionsForTheDay;
      },
      getPerson: function(personId) {

        if(personId==undefined || this.scheduleData == undefined
          || this.scheduleData.people == undefined
          || this.scheduleData.items == undefined)
          return {};

        personObject = {};
        schedule_personObject = this.scheduleData.people[personId];
        personObject.name = schedule_personObject.name;
        personObject.institution = schedule_personObject.institution;
        personObject.papers = [];

        schedule_personObject_paper_ids = schedule_personObject.paper_ids;
        if(schedule_personObject_paper_ids == undefined
          || schedule_personObject_paper_ids == null) {
          return personObject;
        }
        for (var i=0; i<schedule_personObject_paper_ids.length; ++i) {
          paper = window.ml4u.sharedElements.scheduleDataProvider.getItem(schedule_personObject_paper_ids[i]);
          personObject.papers.push(paper);
        }
        console.log("returning:");
        console.log(personObject);

        return personObject;
      },
      getItem: function(itemId) {
        console.log("getItem called with itemId " + itemId);
        if(this.scheduleData == undefined || this.scheduleData.items == undefined)
          return {};
        var orgItem =  this.scheduleData.items[itemId]
        if(orgItem == undefined)
          return {};

        var item = orgItem;
        item.authors = new Array();
        for(var i in orgItem.authorIds) {
          var authorId = orgItem.authorIds[i];
          var person = this.scheduleData.people[authorId];
          item.authors.push(person);
        }
        return item;
      },
      addComment: function(itemId, commentAuthor, commentText) {
        // TODO: query backend to do this
      },
      getItems: function() {
        if(this.scheduleData == undefined || this.scheduleData.items == undefined)
          return {};
        return this.scheduleData.items;
      },
      getSession: function(sessionId) {
        if(this.scheduleData == undefined || this.scheduleData.sessions == undefined)
          return {};
        mapping = this.scheduleData.sessionIdToIndexMapping[sessionId];
        if(mapping == undefined)
          return {};
        session = this.scheduleData.sessions[mapping.dayIndex][mapping.timeslotIndex][mapping.sub_index];
        return session;
      },
      getSessionItems: function(sessionId) {
        if(this.scheduleData == undefined || this.scheduleData.items == undefined)
          return {};
        mapping = this.scheduleData.sessionIdToIndexMapping[sessionId];
        session = this.scheduleData.sessions[mapping.dayIndex][mapping.timeslotIndex][mapping.sub_index];
        papers_ids = session.talks;
        items = [];
        for (var i=0; i<papers_ids.length; ++i) {
          itemid = papers_ids[i].paper_id;
          item = this.scheduleData.items[itemid];
          items.push(item);
        }
        return items;
      },
      getSessionsDaysArray: function() {
        if(this.scheduleData == undefined || this.scheduleData.dailySchedule == undefined)
          return [];
        return this.scheduleData.dailySchedule;
      },
      created: function() {
        window.ml4u = window.ml4u || {};
        window.ml4u.schedDB_local = new PouchDB('schedule');
        window.ml4u.shedDB_remote = new PouchDB('https://icml.papro.org.uk/couchdb/schedule');

        window.ml4u.shedDB_remote.replicate.to(window.ml4u.schedDB_local).on('complete', function () {
          window.ml4u.helpervars = window.ml4u.helpervars || {};
          window.ml4u.helpervars.dbsynced = true;
          if(window.ml4u.helpervars.ml4uappcreated) {
              //window.ml4u.helpervars.ml4u_app_element.removeLoadscreen();
          }
          console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!scheduleData has been downloaded!");
          if(!this.isReady) {
            this.isReady = 1;
          }
          this.fire('iron-signal', {name: 'schedule', data: null});
          window.ml4u.schedDB_local.close();
          window.ml4u.shedDB_remote.close();
        }.bind(this)).on('error', function (err) {
          // boo, something went wrong!
        });
      }
    });
  </script>
</dom-module>
