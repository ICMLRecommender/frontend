<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="ml4u-nav.html">
<link rel="import" href="ml4u-list.html">

<dom-module id="ml4u-page-schedule">
  <template>
    <style include="shared-styles">
      .items_list {
        background-color: white;
      }
    </style>
    <iron-signals on-iron-signal-schedule="_onScheduleDataChanged"><iron-signals>
    <ml4u-nav selected-index="{{selectedDay}}" selected-sub-index={{selectedTrack}} tabs="[[_tabs]]" ></ml4u-nav>
    <div class="items_list">
      <template is="dom-repeat" items="{{_items}}" initialCount="10">
        <ml4u-list-item list-item="{{item}}"
            selected-item="{{selectedItem}}" is-bookmarked=[[item.isBookmarked]]></ml4u-list-item>
      </template>
    </div>
  </template>

  <script>
  Polymer({
    is: 'ml4u-page-schedule',
    properties: {
      route: Object,
      ironRouteHash: {
        type: String,
        observer: '_onIronRouteHashChanged'
      },
      profileData: {
        type: Object,
        notify: true
      },
      loggedIn: {
        type: Number
      },
      selectedItem: {
        type:String,
        notify: true
      },
      selectedDay: {
        type:Number,
        value: 0
      },
      selectedTrack: {
        type:Number,
        value: 0
      },
      _tabs: {
        type: Array,
        value: []
      },
      _items: {
        type: Array,
        value: []
      },
      showPosters: {
        type: Boolean,
        value: false
      }
    },
    observers: [
      '_onSelectedItemsChanged(selectedDay, selectedTrack)',
      'updateBookmarks(_items, profileData.bookmarks)'
    ],
    updateBookmarks: function(sessions, profileData) {
      //console.log("updateBookmarks called?! from page-schedule");
      if(sessions == undefined) {
        return;
      }

      //performing the if out the for loop, so I don't have to evaluate it N times
      if(this.loggedIn && this.profileData.bookmarks != undefined) {
        this._items[0].isBookmarked = 1;
        for(var sessionId=0; sessionId<sessions.length; ++sessionId) {
          current_session = sessions[sessionId];
          cs_items = current_session.talks;
          isBookmarked = false;
          for (var itemIndex=0; itemIndex<cs_items.length; ++itemIndex) {
            if(this.profileData.bookmarks[cs_items[itemIndex].paper_id]) {
              //console.log("success!");
              isBookmarked = true;
              break;
            }
          }
          this.set('_items.' + sessionId + ".isBookmarked", isBookmarked);
          //this._items[sessionId].isBookmarked = 1;
        }
        //console.log("loggin sessions afterwards:");
        //console.log(this._items);
      }
      else {
        for(var i=0; i<sessions.length; ++i) {
          this.set('_items.' + i + ".isBookmarked", 0);
        }
      }
    },
    _onIronRouteHashChanged: function(newVal) {
      if (newVal == undefined || newVal == "") {
        this.selectedDay = 0;
        this.selectedTrack = 0;
      }
      else {
        this.selectedDay = newVal[0];
        this.selectedTrack = newVal.length > 1 ? newVal[1] : 0;
      }
    },

    _onSelectedItemsChanged: function(day, track) {
      if(day == undefined || track==undefined)
        return;
      this._items = window.ml4u.sharedElements.scheduleDataProvider.getSessionsSchedule(day, track);
    },

    _onScheduleDataChanged: function(e) {
      console.log("_onScheduleDataChanged called!!");
      console.log("this.selectedDay=");
      console.log(this.selectedDay);
      this._tabs = window.ml4u.sharedElements.scheduleDataProvider.getSessionsDaysArray();
      this._items = window.ml4u.sharedElements.scheduleDataProvider.getSessionsSchedule(this.selectedDay, this.selectedTrack);
      console.log(this._tabs);
      console.log(this._items);
    },
    ready: function() {
      if(this._tabs.length==0) {
        this._tabs = window.ml4u.sharedElements.scheduleDataProvider.getSessionsDaysArray();
      }
    },
  });

  </script>
</dom-module>
