<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="ml4u-item-user-review.html">
<link rel="import" href="ml4u-item-review.html">
<link rel="import" href="ml4u-item-likes.html">
<link rel="import" href="ml4u-item-comments.html">


<dom-module id="ml4u-item-view">

<style is="custom-style">

  :host {
    padding: 0 0 !important;
    background-color: black !important;
  }

  .container {
    background-color: white;
    margin-bottom: 20px;
    box-shadow: 0px 5px 5px grey;
  }

  paper-icon-button.favourite {
    color:GoldenRod;
  }
  a {
    color:inherit;
    text-decoration: none;
  }

  .cardBlock {
    display: block;
    border-bottom: 1px solid #e0e0e0 !important;
    padding: 10px 24px 10px 24px;
  }

  section.itemViewHeader {
    color: white;
    background-color: var(--app-primary-color);
    padding: 5px;
    font-weight: bold;
    font-size: 20px;

  }

  section.itemViewHeader > span {
    text-align: center;
  }

  .styledbulletpoint {
    color: #9A9A9A;
    font-weight: bold;
  }
  .authorlink {
    color: #3475CC;
    font-weight: bold;
    font-size: 15px;
  }

  .papertitle {
    font-weight: bold;
    font-size: 20px;
    padding: 20px 10px 8px 0px;
  }

  .papericon {
    color: #959595;
  }

  div.sectionTitleContainer {
    display: block;
    height: 22px;
    line-height: 22px;
    font-size: 14px;
    color: #000;
    clear:both;
  }
  span.sectiontitle {
    text-transform: uppercase;
    color: #979797;
    font-weight: bold;
    float: left;
  }
  span.sectionInfo {
    float: right;
  }


</style>
<template>
  <section class="itemViewHeader">
    <paper-icon-button dialog-confirm icon="icons:close"></paper-icon-button>
    <span>Paper</span>
  </section>
  <section class="container">
    <section class="cardBlock">
        <div class="papertitle">[[itemObject.title]]</div>
        <div>
          <template is="dom-repeat" items="{{itemObject.authors}}">
              <a dialog-confirm href="/person?id=[[item.id]]" class="authorlink"><span class="styledbulletpoint">&bull;</span> [[item.name]]</a>
          </template>
        </div>
        <paper-icon-button icon="icons:bookmark" id="favouriteIcon" class="papericon" on-click='_toggleFavourite'></paper-icon-button>
        <paper-icon-button icon="icons:favorite" id="likeIcon" class="papericon" on-click='_toggleFavourite'></paper-icon-button>
    </section>
    <section class="cardBlock">
      <div class="sectionTitleContainer">
        <span class="sectiontitle">Topics</span><span class="sectionInfo">Stats, ML</span>
      </div>
    </section>
    <section class="cardBlock">
      <div class="sectionTitleContainer">
        <span class="sectiontitle">Session</span><span class="sectionInfo">Sat 2pm, Room 12</span>
      </div>
    </section>
    <section class="cardBlock">
      <div class="sectionTitleContainer">
        <span class="sectiontitle">Abstract</span><span class="sectionInfo"><paper-icon-button icon="{{abstractIconStr}}" id="favouriteIcon" class="papericon" on-click='_toggleAbstract'></paper-icon-button></span>
      </div>
      <div hidden$="{{!abstractVisible}}">[[itemObject.description]]</div>
    </section>
  </section>
  <!--
  <paper-button raised class="writeReview" on-tap="writeReviewTapped" hidden$="{{!displayRateItemButton}}">Rate item</paper-button>
  <section class="itemViewUserReview" hidden="{{displayRateItemButton}}">
    <div class="cardBlock">
      <ml4u-item-review  display-rate-item-button="{{displayRateItemButton}}" ></ml4u-item-review>
    </div>
  </section>
  -->
  <section class="itemViewReviews container" hidden="{{!feedbackRetrieved}}">
    <!--
    <div>
      <b>Likes:</b>
      <ml4u-item-likes likes-array={{feedback.likes}}></ml4u-item-likes>
    </div>

    <h3>Comments</h3>
    -->
    <ml4u-item-comments comments-array={{feedback.comments}}></ml4u-item-comments>

      <!--
      <ml4u-user-review author-name="Author Name1" author-institution="Author Institution1" review="Item review1"></ml4u-user-review>
      <ml4u-user-review author-name="Author Name2" author-institution="Author Institution2" review="Item review2"></ml4u-user-review>
          <template is="dom-repeat" items="{{articleObject.reviews}}">
          <ml4u-user-review author-name="[[item.authorName]]" author-institution="[[item.institution]]" review="[[item.review]]"></ml4u-user-view>
          </template>
        -->

  </section>
</template>

<script>
  Polymer({
    is: 'ml4u-item-view',
    properties: {
      itemId : {
        type: Object,
        observer: '_onItemIdChanged'
      },
      itemObject: {
        type: Object,
        observer: '_onItemChanged'
      },
      profileData: {
        type: Object,
        notify: true
      },
      displayRateItemButton: {
        type: Boolean,
        value: true
      },
      loggedIn: {
        type: Boolean,
        computed: '_computeLoggedIn(profileData)'
      },
      feedbackRetrieved: {
        type: Boolean,
        value: false
      },
      feedback: {
        type: Object
      },
      abstractVisible: {
              type: Boolean,
              value: false
      },
      abstractIconStr: {
        type: String,
        value: "hardware:keyboard-arrow-down"
      }
    },
    _toggleAbstract: function() {
      this.abstractVisible = !this.abstractVisible;
      this.abstractIconStr = this.abstractVisible ? "hardware:keyboard-arrow-up" : "hardware:keyboard-arrow-down";
    },
    _computeLoggedIn: function(profileData) {
      return Object.keys(profileData).length != 0
    },
    _onItemIdChanged: function() {
      this.feedbackRetrieved = false;
      this.updateItem();
      this.getFeedback();
    },

    getFeedback: function() {
      var xhr = new XMLHttpRequest();
      // xhr.addEventListener('load', rq.onLoad.bind(this));
      xhr.addEventListener('load', function(e){
        var madeUpResponse = {
          comments : [
            {
              id: "1",
              username: "username1",
              comment: "This paper is actually rather interesting."
            },
            {
              id: "2",
              username: "myusernamel",
              comment: "I couldn't understand a single sentence."
            }
          ],
          likes: ["username1", "myusernamela", "myusernamelaz"]
        };
        this.feedback = madeUpResponse;
        this.feedbackRetrieved = true;
        console.log("!!!!!!!!!!!!!!!!!all is cool!");
      }.bind(this));

      xhr.addEventListener('error', function(e) {
        console.log("!!!!!!!!!!!!!!!!!error received!");
        // for now, no need to do anything
      }.bind(this));

      xhr.open("POST", "https://leggetter-cors.herokuapp.com/", true);
      //xhr.open("POST", "http://localhost:8000/icml/registration/", true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      // xhr.send(rq.uriEncodedPostData);
      xhr.send();
    },


    updateItem: function() {
      if(this.itemId == undefined)
        return;

      this.async(function() {
        var itemId = this.itemId;
        if(itemId === undefined)
          return {};
        item = window.ml4u.sharedElements.scheduleDataProvider.getItem(itemId);
        console.log("computed the following itemObj for itemId " + itemId);
        console.log(item);
        this.itemObject = item;
      });
    },
    _onItemChanged: function(newItemValue) {
      if(newItemValue === undefined)
        return;
      this._updateStars();
    },
    _toggleFavourite: function() {
      if(!this.loggedIn) {
        window.ml4u.sharedElements.papertoast.text = "Please login first.";
        window.ml4u.sharedElements.papertoast.open();
        return;
      }

      console.log("loggin this.profileData from _toggleFavourite");
      console.log(this.profileData);
      this.profileData.bookmarks = this.profileData.bookmarks || {};
      if(this.articleId in this.profileData.bookmarks) {
          delete this.profileData.bookmarks[this.itemId];
          this.notifyPath('profileData.bookmarks.'+this.itemId);
      }
      else {
        this.set('profileData.bookmarks.'+this.itemId, ''+ this.itemId);
        //this.profile.favourites[this.articleId] = this.articleId;
      }
      this._updateStars();
    },

    //Updates the class of the star in order to make it gold, if the item has been added to favourites
    _updateStars : function() {
      console.log("_updateStars called");
      console.log(this.profileData);
      var itemId = this.itemId;

      var isFavourite = this.profileData.bookmarks != undefined && itemId in this.profileData.bookmarks;
      //console.log("checked if " + itemId + " is in");
      //console.log(this.profile.favourites);
      //console.log("result = " + isFavourite);
      if(isFavourite) {
        this.$.favouriteIcon.className = "favourite papericon";
      }
      else{
        this.$.favouriteIcon.className = "papericon";
      }
    },
    writeReviewTapped: function() {
      console.log("writeReviewTapped tapped");
      this.displayRateItemButton = false;
    }
  });
  </script>
</dom-module>
