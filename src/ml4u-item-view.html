<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="ml4u-item-user-review.html">
<link rel="import" href="ml4u-item-review.html">
<link rel="import" href="ml4u-item-likes.html">
<link rel="import" href="ml4u-item-comments.html">


<dom-module id="ml4u-item-view">

<style is="custom-style">
  :host {
    padding: 0 0 !important;
  }

  .container {
    margin-top : 5px;
    clear: right;
  }
  .container > ml4u-user-view, ml4u-user-review {
        padding: 5px;
        margin: 10px;
        background-color: white;
        min-height: 20px;
        min-width: 200px;
        max-width: 250px;
        float:left;
  }
  paper-icon-button.favourite {
    color:GoldenRod;
  }
  a {
    color:inherit;
    text-decoration: none;
  }

  .cardBlock {
    display: block;
    border-bottom: 1px solid #e0e0e0 !important;
    padding: 0px 24px 24px 24px;
  }

  section.itemViewHeader {
    background-color: #F2D7D5;
    padding: 5px;
  }

  paper-button.writeReview {
    /*float: right;*/
  }
  .itemViewUserReview {
    background-color: #f5f5f5;
  }
</style>
<template>
  <section class="itemViewHeader">
    <paper-icon-button dialog-confirm icon="icons:close"></paper-icon-button>
    <span hidden$="[[!loggedIn]]">
      <paper-icon-button hidden$="[[!loggedIn]]" icon="icons:star" id="favouriteIcon" on-click='_toggleFavourite'></paper-icon-button>
    </div>
  </section>
  <section class="itemViewDescription">
    <div class="cardBlock">
      <h1>[[itemObject.title]]</h1>
      <div>[[itemObject.description]]</div>
      <div class="container">
        <template is="dom-repeat" items="{{itemObject.authors}}">
            <a dialog-confirm href="/person?id=[[item.id]]"><iron-icon icon="icons:account-circle"></iron-icon>[[item.name]]</a>
        </template>
      </div>
    </div>
  </section>
  hello [[loggedIn]]
  <paper-button raised class="writeReview" on-tap="writeReviewTapped" hidden$="{{!displayRateItemButton}}">Rate item</paper-button>
  <section class="itemViewUserReview" hidden="{{displayRateItemButton}}">
    <div class="cardBlock">
      <ml4u-item-review  display-rate-item-button="{{displayRateItemButton}}" ></ml4u-item-review>
    </div>
  </section>
  <section class="itemViewReviews" hidden="{{!feedbackRetrieved}}">
    <div>
      <b>Likes:</b>
      <ml4u-item-likes likes-array={{feedback.likes}}></ml4u-item-likes>
    </div>
    <h3>Comments</h3>
    <ml4u-item-comments comments-array={{feedback.comments}}></ml4u-item-comments>

      <!--
      <ml4u-user-review author-name="Author Name1" author-institution="Author Institution1" review="Item review1"></ml4u-user-review>
      <ml4u-user-review author-name="Author Name2" author-institution="Author Institution2" review="Item review2"></ml4u-user-review>
          <template is="dom-repeat" items="{{articleObject.reviews}}">
          <ml4u-user-review author-name="[[item.authorName]]" author-institution="[[item.institution]]" review="[[item.review]]"></ml4u-user-view>
          </template>
        -->

  </section>
</template>

<script>
  Polymer({
    is: 'ml4u-item-view',
    properties: {
      itemId : {
        type: Object,
        observer: '_onItemIdChanged'
      },
      itemObject: {
        type: Object,
        observer: '_onItemChanged'
      },
      profileData: {
        type: Object,
        notify: true
      },
      displayRateItemButton: {
        type: Boolean,
        value: true
      },
      loggedIn: {
        type: Boolean,
        computed: '_computeLoggedIn(profileData)'
      },
      feedbackRetrieved: {
        type: Boolean,
        value: false
      },
      feedback: {
        type: Object
      }
    },
    _computeLoggedIn: function(profileData) {
      return Object.keys(profileData).length != 0
    },
    _onItemIdChanged: function() {
      this.feedbackRetrieved = false;
      this.updateItem();
      this.getFeedback();
    },

    getFeedback: function() {
      var xhr = new XMLHttpRequest();
      // xhr.addEventListener('load', rq.onLoad.bind(this));
      xhr.addEventListener('load', function(e){
        var madeUpResponse = {
          comments : [
            {
              id: "1",
              username: "username1",
              comment: "This paper is actually rather interesting."
            },
            {
              id: "2",
              username: "myusernamel",
              comment: "I couldn't understand a single sentence."
            }
          ],
          likes: ["username1", "myusernamela", "myusernamelaz"]
        };
        this.feedback = madeUpResponse;
        this.feedbackRetrieved = true;
        console.log("!!!!!!!!!!!!!!!!!all is cool!");
      }.bind(this));

      xhr.addEventListener('error', function(e) {
        console.log("!!!!!!!!!!!!!!!!!error received!");
        // for now, no need to do anything
      }.bind(this));

      xhr.open("POST", "https://leggetter-cors.herokuapp.com/", true);
      //xhr.open("POST", "http://localhost:8000/icml/registration/", true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      // xhr.send(rq.uriEncodedPostData);
      xhr.send();
    },


    updateItem: function() {
      if(this.itemId == undefined)
        return;

      this.async(function() {
        var itemId = this.itemId;
        if(itemId === undefined)
          return {};
        item = window.ml4u.sharedElements.scheduleDataProvider.getItem(itemId);
        console.log("computed the following itemObj for itemId " + itemId);
        console.log(item);
        this.itemObject = item;
      });
    },
    _onItemChanged: function(newItemValue) {
      if(newItemValue === undefined)
        return;
      this._updateStars();
    },
    _toggleFavourite: function() {
      if(!this.loggedIn) {
        window.ml4u.sharedElements.papertoast.text = "Please login first.";
        window.ml4u.sharedElements.papertoast.open();
        return;
      }

      console.log("loggin this.profileData from _toggleFavourite");
      console.log(this.profileData);
      this.profileData.bookmarks = this.profileData.bookmarks || {};
      if(this.articleId in this.profileData.bookmarks) {
          delete this.profileData.bookmarks[this.itemId];
          this.notifyPath('profileData.bookmarks.'+this.itemId);
      }
      else {
        this.set('profileData.bookmarks.'+this.itemId, ''+ this.itemId);
        //this.profile.favourites[this.articleId] = this.articleId;
      }
      this._updateStars();
    },

    //Updates the class of the star in order to make it gold, if the item has been added to favourites
    _updateStars : function() {
      console.log("_updateStars called");
      console.log(this.profileData);
      var itemId = this.itemId;

      var isFavourite = this.profileData.bookmarks != undefined && itemId in this.profileData.bookmarks;
      //console.log("checked if " + itemId + " is in");
      //console.log(this.profile.favourites);
      //console.log("result = " + isFavourite);
      if(isFavourite) {
        this.$.favouriteIcon.className = "favourite";
      }
      else{
        this.$.favouriteIcon.className = "";
      }
    },
    writeReviewTapped: function() {
      console.log("writeReviewTapped tapped");
      this.displayRateItemButton = false;
    }
  });
  </script>
</dom-module>
